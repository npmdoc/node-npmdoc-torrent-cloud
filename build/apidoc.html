<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

    >torrent-cloud (v0.1.2)</a>
</h1>
<h4>A torrent client in the cloud</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.torrent-cloud">module torrent-cloud</a><ol>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.</span>_template</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.</span>aws</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.</span>json_api</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.</span>mega</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.</span>screen_scraper</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.</span>search</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.</span>ws</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.torrent-cloud._template">module torrent-cloud._template</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud._template.init">
            function <span class="apidocSignatureSpan">torrent-cloud._template.</span>init
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud._template.list">
            function <span class="apidocSignatureSpan">torrent-cloud._template.</span>list
            <span class="apidocSignatureSpan">(callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud._template.remove">
            function <span class="apidocSignatureSpan">torrent-cloud._template.</span>remove
            <span class="apidocSignatureSpan">(path, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud._template.upload">
            function <span class="apidocSignatureSpan">torrent-cloud._template.</span>upload
            <span class="apidocSignatureSpan">(torrentFile, callback)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud._template.</span>vars</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.torrent-cloud.aws">module torrent-cloud.aws</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.aws.init">
            function <span class="apidocSignatureSpan">torrent-cloud.aws.</span>init
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.aws.list">
            function <span class="apidocSignatureSpan">torrent-cloud.aws.</span>list
            <span class="apidocSignatureSpan">(callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.aws.remove">
            function <span class="apidocSignatureSpan">torrent-cloud.aws.</span>remove
            <span class="apidocSignatureSpan">(path, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.aws.upload">
            function <span class="apidocSignatureSpan">torrent-cloud.aws.</span>upload
            <span class="apidocSignatureSpan">(file, callback)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.aws.</span>vars</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.torrent-cloud.json_api">module torrent-cloud.json_api</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.json_api.item">
            function <span class="apidocSignatureSpan">torrent-cloud.json_api.</span>item
            <span class="apidocSignatureSpan">(p, data, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.json_api.list">
            function <span class="apidocSignatureSpan">torrent-cloud.json_api.</span>list
            <span class="apidocSignatureSpan">(p, data, callback)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.torrent-cloud.mega">module torrent-cloud.mega</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.mega.init">
            function <span class="apidocSignatureSpan">torrent-cloud.mega.</span>init
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.mega.list">
            function <span class="apidocSignatureSpan">torrent-cloud.mega.</span>list
            <span class="apidocSignatureSpan">(callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.mega.remove">
            function <span class="apidocSignatureSpan">torrent-cloud.mega.</span>remove
            <span class="apidocSignatureSpan">(path, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.mega.upload">
            function <span class="apidocSignatureSpan">torrent-cloud.mega.</span>upload
            <span class="apidocSignatureSpan">(torrentFile, callback)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.mega.</span>vars</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.torrent-cloud.screen_scraper">module torrent-cloud.screen_scraper</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.screen_scraper.item">
            function <span class="apidocSignatureSpan">torrent-cloud.screen_scraper.</span>item
            <span class="apidocSignatureSpan">(p, data, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.screen_scraper.list">
            function <span class="apidocSignatureSpan">torrent-cloud.screen_scraper.</span>list
            <span class="apidocSignatureSpan">(p, data, callback)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.torrent-cloud.search">module torrent-cloud.search</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.search.item">
            function <span class="apidocSignatureSpan">torrent-cloud.search.</span>item
            <span class="apidocSignatureSpan">(data, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.search.list">
            function <span class="apidocSignatureSpan">torrent-cloud.search.</span>list
            <span class="apidocSignatureSpan">(data, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.search.setproviders">
            function <span class="apidocSignatureSpan">torrent-cloud.search.</span>setproviders
            <span class="apidocSignatureSpan">(data, callback)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">number <span class="apidocSignatureSpan">torrent-cloud.search.</span>_eventsCount</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.search.</span>_events</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.search.</span>domain</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">torrent-cloud.search.</span>providers</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.torrent-cloud.ws">module torrent-cloud.ws</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.ws.broadcast">
            function <span class="apidocSignatureSpan">torrent-cloud.ws.</span>broadcast
            <span class="apidocSignatureSpan">(d)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.torrent-cloud.ws.install">
            function <span class="apidocSignatureSpan">torrent-cloud.ws.</span>install
            <span class="apidocSignatureSpan">(server)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.torrent-cloud" id="apidoc.module.torrent-cloud">module torrent-cloud</a></h1>















</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.torrent-cloud._template" id="apidoc.module.torrent-cloud._template">module torrent-cloud._template</a></h1>


    <h2>
        <a href="#apidoc.element.torrent-cloud._template.init" id="apidoc.element.torrent-cloud._template.init">
        function <span class="apidocSignatureSpan">torrent-cloud._template.</span>init
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">init = function (config) {
	config.MY_VAR_1
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	//now check its validity

	backend.name = name;

	if(!backend.init)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;init(env vars...)&#x27; function&#x22;);

	backend.<span class="apidocCodeKeywordSpan">init</span>(config);

	if(typeof backend.upload !== &#x22;function&#x22;)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;upload(torrent file, callback)&#x27; function&#x22;);

	if(typeof backend.remove !== &#x22;function&#x22;)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;remove(path, callback)&#x27; function&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud._template.list" id="apidoc.element.torrent-cloud._template.list">
        function <span class="apidocSignatureSpan">torrent-cloud._template.</span>list
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">list = function (callback) {
	callback(null, {
		//original path to file (torrentFile.path)
		&#x22;path1&#x22;: {
			length: 0, //total length of file in bytes
			url: &#x22;&#x22; //public url to file
		},
		&#x22;path2&#x22;: {
			//...
		}
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	});
};
search.on(&#x22;update&#x22;, update);
torrents.on(&#x22;update&#x22;, update);

//periodically scan for new stored files
function list() {
	backend.<span class="apidocCodeKeywordSpan">list</span>(function(err, files) {
		if(!err) update(files);
	});
}
setInterval(list, 15*60*1000);
list();

server.on(&#x22;error&#x22;, function(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud._template.remove" id="apidoc.element.torrent-cloud._template.remove">
        function <span class="apidocSignatureSpan">torrent-cloud._template.</span>remove
        <span class="apidocSignatureSpan">(path, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove = function (path, callback) {
	callback(null);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};

torrents.trash = function(data, callback) {

	if(!data.path)
		return callback(&#x22;Missing path&#x22;);

	backend.<span class="apidocCodeKeywordSpan">remove</span>(data.path, function(err) {
		if(err) return callback(&#x22;Failed to trash: &#x22; + err);

		backend.list(function(err, files) {
			if(err) return callback(&#x22;Failed to list: &#x22; + err);
			torrents.emit(&#x22;update&#x22;, files);
			callback(null);
		});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud._template.upload" id="apidoc.element.torrent-cloud._template.upload">
        function <span class="apidocSignatureSpan">torrent-cloud._template.</span>upload
        <span class="apidocSignatureSpan">(torrentFile, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">upload = function (torrentFile, callback) {
	//torrentFile is an object, with properties:
	//	path - string
	//	length - length of file (IMPORTANT: when zipping all files,
	// 			we don&#x27;t know exact length, so always try to use multipart uploads where length
	//			is not required, else buffer the file)
	//	createReadStream - function() begins to download file, returns a stream object
	//						you must handle the &#x22;error&#x22; event!
	//				(note: stream staggered to prevent backlog from slow uploads)
	
	//callback when stream has been fully uploaded
	callback(null);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	//callback to user early since uploads can take hours...
	//user receives updates via websockets
	callback(null);
	file.uploading = true;
	torrents.emit(&#x22;update&#x22;);

	//pass copy of file to backend
	backend.<span class="apidocCodeKeywordSpan">upload</span>({
		path: file.path,
		length: file.length,
		createReadStream: file.createReadStream.bind(file)
	}, function(err) {
		file.uploading = false;
		//receive result from backend
		if(err &#x26;&#x26; err !== &#x22;cancelled&#x22;) {
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.torrent-cloud.aws" id="apidoc.module.torrent-cloud.aws">module torrent-cloud.aws</a></h1>


    <h2>
        <a href="#apidoc.element.torrent-cloud.aws.init" id="apidoc.element.torrent-cloud.aws.init">
        function <span class="apidocSignatureSpan">torrent-cloud.aws.</span>init
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">init = function (config) {
	bucket = config.AWS_BUCKET;
	region = config.AWS_REGION;

	//init s3
	s3 = new AWS.S3({
		accessKeyId: config.AWS_ACCESS_KEY,
		secretAccessKey: config.AWS_SECRET_KEY,
		region: config.AWS_REGION
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	//now check its validity

	backend.name = name;

	if(!backend.init)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;init(env vars...)&#x27; function&#x22;);

	backend.<span class="apidocCodeKeywordSpan">init</span>(config);

	if(typeof backend.upload !== &#x22;function&#x22;)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;upload(torrent file, callback)&#x27; function&#x22;);

	if(typeof backend.remove !== &#x22;function&#x22;)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;remove(path, callback)&#x27; function&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.aws.list" id="apidoc.element.torrent-cloud.aws.list">
        function <span class="apidocSignatureSpan">torrent-cloud.aws.</span>list
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">list = function (callback) {
	s3.listObjects({Bucket:bucket}, function(err, data) {
		if (err)
			return callback(err);
		var files = {};
		data.Contents.forEach(function(o){
			files[o.Key] = {
				length: o.Size,
				url: &#x27;https://s3-&#x27;+region+&#x27;.amazonaws.com/&#x27;+bucket+&#x27;/&#x27; + o.Key
			};
		});
		callback(null, files);
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	});
};
search.on(&#x22;update&#x22;, update);
torrents.on(&#x22;update&#x22;, update);

//periodically scan for new stored files
function list() {
	backend.<span class="apidocCodeKeywordSpan">list</span>(function(err, files) {
		if(!err) update(files);
	});
}
setInterval(list, 15*60*1000);
list();

server.on(&#x22;error&#x22;, function(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.aws.remove" id="apidoc.element.torrent-cloud.aws.remove">
        function <span class="apidocSignatureSpan">torrent-cloud.aws.</span>remove
        <span class="apidocSignatureSpan">(path, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove = function (path, callback) {
	s3.deleteObject({ Bucket:bucket, Key: path }, callback);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};

torrents.trash = function(data, callback) {

	if(!data.path)
		return callback(&#x22;Missing path&#x22;);

	backend.<span class="apidocCodeKeywordSpan">remove</span>(data.path, function(err) {
		if(err) return callback(&#x22;Failed to trash: &#x22; + err);

		backend.list(function(err, files) {
			if(err) return callback(&#x22;Failed to list: &#x22; + err);
			torrents.emit(&#x22;update&#x22;, files);
			callback(null);
		});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.aws.upload" id="apidoc.element.torrent-cloud.aws.upload">
        function <span class="apidocSignatureSpan">torrent-cloud.aws.</span>upload
        <span class="apidocSignatureSpan">(file, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">upload = function (file, callback) {
	queue.push(file, callback);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	//callback to user early since uploads can take hours...
	//user receives updates via websockets
	callback(null);
	file.uploading = true;
	torrents.emit(&#x22;update&#x22;);

	//pass copy of file to backend
	backend.<span class="apidocCodeKeywordSpan">upload</span>({
		path: file.path,
		length: file.length,
		createReadStream: file.createReadStream.bind(file)
	}, function(err) {
		file.uploading = false;
		//receive result from backend
		if(err &#x26;&#x26; err !== &#x22;cancelled&#x22;) {
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.torrent-cloud.json_api" id="apidoc.module.torrent-cloud.json_api">module torrent-cloud.json_api</a></h1>


    <h2>
        <a href="#apidoc.element.torrent-cloud.json_api.item" id="apidoc.element.torrent-cloud.json_api.item">
        function <span class="apidocSignatureSpan">torrent-cloud.json_api.</span>item
        <span class="apidocSignatureSpan">(p, data, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">item = function (p, data, callback) {
	callback(&#x22;Not implemented&#x22;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.json_api.list" id="apidoc.element.torrent-cloud.json_api.list">
        function <span class="apidocSignatureSpan">torrent-cloud.json_api.</span>list
        <span class="apidocSignatureSpan">(p, data, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">list = function (p, data, callback) {
	callback(&#x22;Not implemented&#x22;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	});
};
search.on(&#x22;update&#x22;, update);
torrents.on(&#x22;update&#x22;, update);

//periodically scan for new stored files
function list() {
	backend.<span class="apidocCodeKeywordSpan">list</span>(function(err, files) {
		if(!err) update(files);
	});
}
setInterval(list, 15*60*1000);
list();

server.on(&#x22;error&#x22;, function(err) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.torrent-cloud.mega" id="apidoc.module.torrent-cloud.mega">module torrent-cloud.mega</a></h1>


    <h2>
        <a href="#apidoc.element.torrent-cloud.mega.init" id="apidoc.element.torrent-cloud.mega.init">
        function <span class="apidocSignatureSpan">torrent-cloud.mega.</span>init
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">init = function (config) {
  storage = mega({
    email: config.MEGA_EMAIL,
    password: config.MEGA_PASS
  }, function(err) {
    if(err) {
      console.log(&#x22;Mega login failed: %s&#x22;, err);
      process.exit(1);
    }
    console.log(&#x22;Mega login success&#x22;);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	//now check its validity

	backend.name = name;

	if(!backend.init)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;init(env vars...)&#x27; function&#x22;);

	backend.<span class="apidocCodeKeywordSpan">init</span>(config);

	if(typeof backend.upload !== &#x22;function&#x22;)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;upload(torrent file, callback)&#x27; function&#x22;);

	if(typeof backend.remove !== &#x22;function&#x22;)
		exit(&#x22;Backend &#x22; + name + &#x22; missing &#x27;remove(path, callback)&#x27; function&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.mega.list" id="apidoc.element.torrent-cloud.mega.list">
        function <span class="apidocSignatureSpan">torrent-cloud.mega.</span>list
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">list = function (callback) {

  storage.reload(function(err) {
    if(err)
      return callback(&#x22;Mega list-dir failed: &#x22; + err);

    var fetches = [];
    var files = {};

    eachFile(function(f) {
      if(f.directory)
        return;
      var path = getPath(f);
      var tcldFile = { length: f.size, url: null };
      fetches.push(function fetchUrl(cb) {
        f.link(function(err, url) {
          if(err) return cb(err);
          tcldFile.url = url;
          cb(null);
        });
      });
      //url is null until it is fetched
      files[path] = tcldFile;
    });

    //fetch all links, 6 at a time
    async.parallelLimit(fetches, 6, function(err) {
      if(err)
        return callback(&#x22;Mega fetch-url failed: &#x22; + err);
      // console.log(&#x22;list success&#x22;, files);
      callback(null, files);
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	});
};
search.on(&#x22;update&#x22;, update);
torrents.on(&#x22;update&#x22;, update);

//periodically scan for new stored files
function list() {
	backend.<span class="apidocCodeKeywordSpan">list</span>(function(err, files) {
		if(!err) update(files);
	});
}
setInterval(list, 15*60*1000);
list();

server.on(&#x22;error&#x22;, function(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.mega.remove" id="apidoc.element.torrent-cloud.mega.remove">
        function <span class="apidocSignatureSpan">torrent-cloud.mega.</span>remove
        <span class="apidocSignatureSpan">(path, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove = function (path, callback) {

  var parts = path.split(&#x22;/&#x22;);
  var file = null;
  var dir = storage.root;

  while(parts.length) {
    var p = parts.shift();
    if(!dir.directory)
      return callback(&#x22;Missing&#x22;);

    var f = null;
    for(var i = 0; i &#x3c; dir.children.length; i++) {
      var c = dir.children[i];
      if(c.name === p) {
        f = c;
        break;
      }
    }

    if(!f)
      return callback(&#x22;Missing&#x22;);
    dir = file = f;
  }

  f.delete(function(err) {
    if(err)
      return callback(err);
    console.log(&#x22;deleted&#x22;, path);
    setTimeout(callback, 5000);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};

torrents.trash = function(data, callback) {

	if(!data.path)
		return callback(&#x22;Missing path&#x22;);

	backend.<span class="apidocCodeKeywordSpan">remove</span>(data.path, function(err) {
		if(err) return callback(&#x22;Failed to trash: &#x22; + err);

		backend.list(function(err, files) {
			if(err) return callback(&#x22;Failed to list: &#x22; + err);
			torrents.emit(&#x22;update&#x22;, files);
			callback(null);
		});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.mega.upload" id="apidoc.element.torrent-cloud.mega.upload">
        function <span class="apidocSignatureSpan">torrent-cloud.mega.</span>upload
        <span class="apidocSignatureSpan">(torrentFile, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">upload = function (torrentFile, callback) {
  if(!storage.root)
    callback(&#x22;Not ready&#x22;);

  var dirs = torrentFile.path.split(&#x22;/&#x22;);
  var name = dirs.pop();
  var dir = null;
  var root = storage.root;

  //call back when all dirs made
  mkdirp(dirs, root, function(err, dir) {
    if(err)
      return callback(err);
    upload(dir);
  });

  //before we can upload, we need to mkdirp
  function mkdirp(dirs, parent, cb) {
    var d = dirs.shift();
    storage.mkdir({
      name: d,
      target: parent
    }, function(err, dir) {
      if(err)
        return cb(err);
      if(dirs.length &#x3e; 0) //dont callback yet!
        mkdirp(dirs, dir, cb);
      else
        cb(null, dir);
    });
  }

  function upload(dir) {
    var upload = storage.upload({
      name: name,
      size: torrentFile.length,
      target: dir
    });

    var stream = torrentFile.createReadStream();

    stream.pipe(upload);

    upload.on(&#x22;error&#x22;, function(err) {
      callback(err);
    });

    //callback when stream has been fully uploaded
    upload.on(&#x22;complete&#x22;, function(f) {
      console.log(&#x22;uploaded&#x22;, f.name);
      callback(null);
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	//callback to user early since uploads can take hours...
	//user receives updates via websockets
	callback(null);
	file.uploading = true;
	torrents.emit(&#x22;update&#x22;);

	//pass copy of file to backend
	backend.<span class="apidocCodeKeywordSpan">upload</span>({
		path: file.path,
		length: file.length,
		createReadStream: file.createReadStream.bind(file)
	}, function(err) {
		file.uploading = false;
		//receive result from backend
		if(err &#x26;&#x26; err !== &#x22;cancelled&#x22;) {
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.torrent-cloud.screen_scraper" id="apidoc.module.torrent-cloud.screen_scraper">module torrent-cloud.screen_scraper</a></h1>


    <h2>
        <a href="#apidoc.element.torrent-cloud.screen_scraper.item" id="apidoc.element.torrent-cloud.screen_scraper.item">
        function <span class="apidocSignatureSpan">torrent-cloud.screen_scraper.</span>item
        <span class="apidocSignatureSpan">(p, data, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">item = function (p, data, callback) {

	if(!p.item)
		return callback(&#x22;Provider cannot retrieve items&#x22;);
	if(!data.url)
		return callback(&#x22;Missing url&#x22;);

	load(data.url, function(err, root) {
		if(err)
			return callback(&#x22;Failed to load: &#x22; + data.url);

		var result = {};
		for(var k in p.item) {
			var v = val(root, p.item[k]);
			if(v) result[k] = v;
		}

		// console.log(data.url, result);
		callback(null, result);
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.screen_scraper.list" id="apidoc.element.torrent-cloud.screen_scraper.list">
        function <span class="apidocSignatureSpan">torrent-cloud.screen_scraper.</span>list
        <span class="apidocSignatureSpan">(p, data, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">list = function (p, data, callback) {
	if(!data || !data.query)
		return callback(&#x22;Missing query&#x22;);

	var page = data.page || 1;

	var url = template(p.list.url, {
		page: page,
		zpage: page-1,//zero-indexed page
		query: data.query
	});

	var origin = /(https?:\/\/[^\/]+)/.test(url) &#x26;&#x26; RegExp.$1;
	if(!origin)
		return callback(&#x22;Invalid URL&#x22;);

	load(url, function (err, root) {
		if(err)
			return callback(&#x22;Search provider could not reached&#x22;);

		var items = root.find(p.list.items);

		// console.log(&#x22;loaded %s, selector &#x27;%s&#x27; yeilds %s results&#x22;,  url, p.list.items, items.length);

		var results = [];
		for(var i = 0; i &#x3c; items.length; i++) {
			var item = items[i];
			var missing = false;
			var result = {};
			for(var k in p.list.item) {
				var v = val(item, p.list.item[k]);
				//exclude items with missing values
				if(!v) {
					missing = true;
					break;
				}
				//url convert rela-&#x3e;abs
				if(k === &#x22;url&#x22; &#x26;&#x26; v &#x26;&#x26; v[0] === &#x22;/&#x22;)
					v = origin + v;
				//insert
				result[k] = v;
			}

			if(!missing)
				results.push(result);
		}

		callback(null, results);
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	});
};
search.on(&#x22;update&#x22;, update);
torrents.on(&#x22;update&#x22;, update);

//periodically scan for new stored files
function list() {
	backend.<span class="apidocCodeKeywordSpan">list</span>(function(err, files) {
		if(!err) update(files);
	});
}
setInterval(list, 15*60*1000);
list();

server.on(&#x22;error&#x22;, function(err) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.torrent-cloud.search" id="apidoc.module.torrent-cloud.search">module torrent-cloud.search</a></h1>


    <h2>
        <a href="#apidoc.element.torrent-cloud.search.item" id="apidoc.element.torrent-cloud.search.item">
        function <span class="apidocSignatureSpan">torrent-cloud.search.</span>item
        <span class="apidocSignatureSpan">(data, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">item = function (data, callback) {

		var p = providers[data.provider];
		if(!p)
			return callback(&#x22;Missing provider: &#x22; + data.provider);

		var type = types[p.type];
		if(!type)
			return callback(&#x22;Invalid type&#x22;);

		type[fnName](p, data, callback);
	}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.search.list" id="apidoc.element.torrent-cloud.search.list">
        function <span class="apidocSignatureSpan">torrent-cloud.search.</span>list
        <span class="apidocSignatureSpan">(data, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">list = function (data, callback) {

		var p = providers[data.provider];
		if(!p)
			return callback(&#x22;Missing provider: &#x22; + data.provider);

		var type = types[p.type];
		if(!type)
			return callback(&#x22;Invalid type&#x22;);

		type[fnName](p, data, callback);
	}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	});
};
search.on(&#x22;update&#x22;, update);
torrents.on(&#x22;update&#x22;, update);

//periodically scan for new stored files
function list() {
	backend.<span class="apidocCodeKeywordSpan">list</span>(function(err, files) {
		if(!err) update(files);
	});
}
setInterval(list, 15*60*1000);
list();

server.on(&#x22;error&#x22;, function(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.search.setproviders" id="apidoc.element.torrent-cloud.search.setproviders">
        function <span class="apidocSignatureSpan">torrent-cloud.search.</span>setproviders
        <span class="apidocSignatureSpan">(data, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setproviders = function (data, callback) {
	if(!data.url)
		return callback(&#x22;Missing url&#x22;);
	request.get(data.url, function(err, httpResponse, body) {
		if(err)
			return callback(&#x22;Failed to load: &#x22; + data.url);
		try {
			var newProviders = JSON.parse(body);
			//expose only the &#x22;names&#x22; to the frontend
			var names = {};
			for(var id in newProviders) {
				var p = newProviders[id];
				names[id] = p.name;
			}
			providers = newProviders;
			search.providers = names;
			search.emit(&#x22;update&#x22;);
			console.log(&#x22;loaded search providers: %s&#x22;, Object.keys(names).join(&#x22;, &#x22;));
			callback(null, names);
		} catch(err) {
			return callback(&#x22;Invalid JSON&#x22;);
		}
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		} catch(err) {
			return callback(&#x22;Invalid JSON&#x22;);
		}
	});
};

var url = process.env.SEARCH_PROVIDERS_URL;
if(url) search.<span class="apidocCodeKeywordSpan">setproviders</span>({url:url}, function(err, p) {
	if(err) console.error(&#x22;Failed to load search providers from: %s (%s)&#x22;, url, err);	
});
...</pre></li>
    </ul>










</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.torrent-cloud.ws" id="apidoc.module.torrent-cloud.ws">module torrent-cloud.ws</a></h1>


    <h2>
        <a href="#apidoc.element.torrent-cloud.ws.broadcast" id="apidoc.element.torrent-cloud.ws.broadcast">
        function <span class="apidocSignatureSpan">torrent-cloud.ws.</span>broadcast
        <span class="apidocSignatureSpan">(d)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">broadcast = function (d) {
	data = d; //always use latest broadcast
	if(queued) return;
	queued = true;
	setTimeout(broadcast, THROTTLE);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

//broadcast state on &#x22;update&#x22;
var update = function(newFiles) {
	//optionally update stored files
	if(newFiles)
		storedFiles = newFiles;
	//broadcast state
	ws.<span class="apidocCodeKeywordSpan">broadcast</span>({
		config: config,
		providers: search.providers,
		torrents: torrents.list,
		filesDownloading: torrents.filesDownloading,
		uploads: storedFiles
	});
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.torrent-cloud.ws.install" id="apidoc.element.torrent-cloud.ws.install">
        function <span class="apidocSignatureSpan">torrent-cloud.ws.</span>install
        <span class="apidocSignatureSpan">(server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">install = function (server) {

	var ws = new WebSocket.Server({ server: server });

	//this is required to allow the error to fall
	//through to the http server
	ws.on(&#x22;error&#x22;, function() {});

	ws.on(&#x27;connection&#x27;, function connection(conn) {
		//safe send
		conn.ssend = function(str){
			if(this.readyState === WebSocket.OPEN)
				this.send(str);
		};
		//track all connections
		conns.push(conn);
		conn.on(&#x27;close&#x27;, function() {
			var i = conns.indexOf(conn);
			if(i &#x3e;= 0) conns.splice(i, 1);
		});

		//noop (dont buffer data)
		conn.on(&#x27;data&#x27;, function() {
		});

		//initially sends the last broadcast
		if(json) conn.ssend(json);
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
//global auth
var user = process.env.AUTH_USER || &#x27;admin&#x27;;
var password = process.env.AUTH_PASSWORD;
if(password)
	app.use(basicAuth(user, password));

//hook http server
ws.<span class="apidocCodeKeywordSpan">install</span>(server);

//all requests have JSON body
app.use(bodyParser.json());

//convert all of the given module&#x27;s
//exposed functions into API endpoints
function api(name, module) {
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
